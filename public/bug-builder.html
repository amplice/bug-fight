<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bug Builder - 3D Modular Bug Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.142.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.142.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0d1117;
            color: #e6edf3;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            min-height: 100vh;
        }

        /* Left Panel - Part Selection */
        .parts-panel {
            background: #161b22;
            padding: 15px;
            border-right: 1px solid #30363d;
            overflow-y: auto;
            max-height: 100vh;
        }

        .parts-panel h2 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .part-category {
            margin-bottom: 20px;
        }

        .part-category h3 {
            color: #8b949e;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .part-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .part-option {
            background: #21262d;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
        }

        .part-option:hover {
            border-color: #58a6ff;
            background: #1f6feb33;
        }

        .part-option.selected {
            border-color: #58a6ff;
            background: #1f6feb55;
        }

        /* Center - Main Preview */
        .preview-panel {
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .main-preview {
            flex: 1;
            position: relative;
        }

        #main-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .preview-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            background: #161b22ee;
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid #30363d;
        }

        .preview-controls button {
            background: #21262d;
            border: 1px solid #30363d;
            color: #e6edf3;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-controls button:hover {
            background: #30363d;
            border-color: #58a6ff;
        }

        /* Parts Preview Row */
        .parts-preview {
            display: flex;
            height: 150px;
            border-top: 1px solid #30363d;
            background: #161b22;
        }

        .part-preview-item {
            flex: 1;
            border-right: 1px solid #30363d;
            position: relative;
            cursor: pointer;
        }

        .part-preview-item:last-child {
            border-right: none;
        }

        .part-preview-item canvas {
            width: 100%;
            height: 100%;
        }

        .part-preview-item .label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            background: #0d1117cc;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            color: #8b949e;
        }

        .part-preview-item:hover .label {
            color: #58a6ff;
        }

        /* Right Panel - Stats & Colors */
        .stats-panel {
            background: #161b22;
            padding: 15px;
            border-left: 1px solid #30363d;
            overflow-y: auto;
            max-height: 100vh;
        }

        .stats-panel h2 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 1px solid #30363d;
            padding-bottom: 10px;
        }

        .color-picker {
            margin-bottom: 20px;
        }

        .color-picker label {
            display: block;
            margin-bottom: 5px;
            color: #8b949e;
            font-size: 0.85em;
        }

        .color-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .color-row input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .color-row input[type="range"] {
            flex: 1;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: #8b949e;
            font-size: 0.85em;
        }

        .slider-group input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .stat-display {
            background: #21262d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .stat-row .value {
            color: #58a6ff;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .action-buttons button {
            background: #238636;
            border: none;
            color: white;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .action-buttons button:hover {
            background: #2ea043;
        }

        .action-buttons button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }

        .action-buttons button.secondary:hover {
            background: #30363d;
        }

        /* Genome JSON display */
        .genome-json {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 0.75em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #58a6ff;
            font-size: 1.5em;
        }

        .header a {
            color: #8b949e;
            text-decoration: none;
        }

        .header a:hover {
            color: #58a6ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Bug Builder - 3D Modular Generator</h1>
        <a href="/">Back to Arena</a>
    </div>

    <div class="container">
        <!-- Left Panel - Part Selection -->
        <div class="parts-panel">
            <h2>Body Parts</h2>

            <div class="part-category">
                <h3>Weapon</h3>
                <div class="part-options" id="weapon-options">
                    <div class="part-option selected" data-value="mandibles">Mandibles</div>
                    <div class="part-option" data-value="fangs">Fangs</div>
                    <div class="part-option" data-value="stinger">Stinger</div>
                    <div class="part-option" data-value="horn">Horn</div>
                    <div class="part-option" data-value="pincers">Pincers</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Leg Style</h3>
                <div class="part-options" id="leg-options">
                    <div class="part-option selected" data-value="insect">Insect</div>
                    <div class="part-option" data-value="spider">Spider</div>
                    <div class="part-option" data-value="mantis">Mantis</div>
                    <div class="part-option" data-value="grasshopper">Grasshopper</div>
                    <div class="part-option" data-value="beetle">Beetle</div>
                    <div class="part-option" data-value="stick">Stick</div>
                    <div class="part-option" data-value="centipede">Centipede</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Mobility</h3>
                <div class="part-options" id="mobility-options">
                    <div class="part-option" data-value="ground">Ground</div>
                    <div class="part-option selected" data-value="winged">Winged</div>
                    <div class="part-option" data-value="wallcrawler">Wallcrawler</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Wing Type</h3>
                <div class="part-options" id="wing-options">
                    <div class="part-option selected" data-value="fly">Fly</div>
                    <div class="part-option" data-value="beetle">Beetle</div>
                    <div class="part-option" data-value="dragonfly">Dragonfly</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Defense</h3>
                <div class="part-options" id="defense-options">
                    <div class="part-option selected" data-value="none">None</div>
                    <div class="part-option" data-value="shell">Shell</div>
                    <div class="part-option" data-value="agility">Agility</div>
                    <div class="part-option" data-value="toxic">Toxic</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Texture</h3>
                <div class="part-options" id="texture-options">
                    <div class="part-option selected" data-value="smooth">Smooth</div>
                    <div class="part-option" data-value="plated">Plated</div>
                    <div class="part-option" data-value="rough">Rough</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Pattern</h3>
                <div class="part-options" id="pattern-options">
                    <div class="part-option selected" data-value="solid">Solid</div>
                    <div class="part-option" data-value="striped">Striped</div>
                    <div class="part-option" data-value="spotted">Spotted</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Head Type</h3>
                <div class="part-options" id="head-options">
                    <div class="part-option selected" data-value="round">Round</div>
                    <div class="part-option" data-value="triangular">Triangular</div>
                    <div class="part-option" data-value="square">Square</div>
                    <div class="part-option" data-value="elongated">Elongated</div>
                    <div class="part-option" data-value="shield">Shield</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Thorax Type</h3>
                <div class="part-options" id="thorax-options">
                    <div class="part-option selected" data-value="compact">Compact</div>
                    <div class="part-option" data-value="elongated">Elongated</div>
                    <div class="part-option" data-value="wide">Wide</div>
                    <div class="part-option" data-value="humped">Humped</div>
                    <div class="part-option" data-value="segmented">Segmented</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Abdomen Type</h3>
                <div class="part-options" id="abdomen-options">
                    <div class="part-option selected" data-value="round">Round</div>
                    <div class="part-option" data-value="oval">Oval</div>
                    <div class="part-option" data-value="pointed">Pointed</div>
                    <div class="part-option" data-value="bulbous">Bulbous</div>
                    <div class="part-option" data-value="segmented">Segmented</div>
                    <div class="part-option" data-value="sac">Sac</div>
                    <div class="part-option" data-value="plated">Plated</div>
                    <div class="part-option" data-value="tailed">Tailed</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Eye Style</h3>
                <div class="part-options" id="eye-options">
                    <div class="part-option selected" data-value="compound">Compound</div>
                    <div class="part-option" data-value="simple">Simple</div>
                    <div class="part-option" data-value="stalked">Stalked</div>
                    <div class="part-option" data-value="multiple">Multiple</div>
                    <div class="part-option" data-value="sunken">Sunken</div>
                </div>
            </div>

            <div class="part-category">
                <h3>Antenna Style</h3>
                <div class="part-options" id="antenna-options">
                    <div class="part-option selected" data-value="segmented">Segmented</div>
                    <div class="part-option" data-value="clubbed">Clubbed</div>
                    <div class="part-option" data-value="whip">Whip</div>
                    <div class="part-option" data-value="horned">Horned</div>
                    <div class="part-option" data-value="nubs">Nubs</div>
                    <div class="part-option" data-value="none">None</div>
                </div>
            </div>
        </div>

        <!-- Center - Main Preview -->
        <div class="preview-panel">
            <div class="main-preview">
                <canvas id="main-canvas"></canvas>
                <div class="preview-controls">
                    <button onclick="resetCamera()">Reset Camera</button>
                    <button onclick="toggleRotation()">Auto Rotate</button>
                    <button onclick="toggleWireframe()">Wireframe</button>
                    <button onclick="playAnimation()">Animate</button>
                    <select id="anim-state" onchange="setAnimState(this.value)">
                        <option value="idle">Idle/Walk</option>
                        <option value="attack">Attack</option>
                        <option value="hit">Hit</option>
                        <option value="death">Death</option>
                        <option value="victory">Victory</option>
                    </select>
                </div>
            </div>
            <div class="parts-preview" id="parts-preview">
                <!-- Part preview canvases will be added here -->
            </div>
        </div>

        <!-- Right Panel - Stats & Colors -->
        <div class="stats-panel">
            <h2>Appearance</h2>

            <div class="color-picker">
                <div class="color-row">
                    <label>Primary Color</label>
                    <input type="color" id="primary-color" value="#4a7c59">
                </div>
                <div class="slider-group">
                    <label>Hue <span id="hue-value">120</span></label>
                    <input type="range" id="hue-slider" min="0" max="360" value="120">
                </div>
                <div class="slider-group">
                    <label>Saturation <span id="sat-value">50</span>%</label>
                    <input type="range" id="sat-slider" min="0" max="100" value="50">
                </div>
                <div class="slider-group">
                    <label>Lightness <span id="light-value">40</span>%</label>
                    <input type="range" id="light-slider" min="10" max="80" value="40">
                </div>
            </div>

            <h2>Stats</h2>

            <div class="slider-group">
                <label>Bulk <span id="bulk-value">50</span></label>
                <input type="range" id="bulk-slider" min="20" max="100" value="50">
            </div>

            <div class="slider-group">
                <label>Speed <span id="speed-value">50</span></label>
                <input type="range" id="speed-slider" min="20" max="100" value="50">
            </div>

            <div class="slider-group">
                <label>Fury <span id="fury-value">50</span></label>
                <input type="range" id="fury-slider" min="20" max="100" value="50">
            </div>

            <div class="slider-group">
                <label>Instinct <span id="instinct-value">50</span></label>
                <input type="range" id="instinct-slider" min="20" max="100" value="50">
            </div>

            <div class="stat-display">
                <div class="stat-row">
                    <span>HP</span>
                    <span class="value" id="hp-display">80</span>
                </div>
                <div class="stat-row">
                    <span>Stamina</span>
                    <span class="value" id="stamina-display">100</span>
                </div>
                <div class="stat-row">
                    <span>Power Rating</span>
                    <span class="value" id="power-display">200</span>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="randomizeBug()">Randomize Bug</button>
                <button onclick="exportGenome()" class="secondary">Export Genome</button>
                <button onclick="copyGenome()" class="secondary">Copy to Clipboard</button>
            </div>

            <h2 style="margin-top: 20px;">Genome</h2>
            <div class="genome-json" id="genome-display"></div>
        </div>
    </div>

    <script src="js/procedural.js"></script>
    <script src="js/bugGenerator3d.js"></script>
    <script>
        // ============================================
        // STATE
        // ============================================

        let mainScene, mainCamera, mainRenderer, mainControls;
        let currentBug = null;
        let animator = null;
        let autoRotate = false;
        let wireframeMode = false;
        let animating = false;
        let animState = 'idle';
        let walkSpeed = 0;

        // Part preview scenes
        let partPreviews = {};

        // Current genome configuration
        let currentConfig = {
            weapon: 'mandibles',
            legStyle: 'insect',
            mobility: 'winged',
            wingType: 'fly',
            defense: 'none',
            textureType: 'smooth',
            pattern: 'solid',
            headType: 'round',
            thoraxType: 'compact',
            abdomenType: 'round',
            eyeStyle: 'compound',
            antennaStyle: 'segmented',
            hue: 120,
            saturation: 50,
            lightness: 40,
            bulk: 50,
            speed: 50,
            fury: 50,
            instinct: 50,
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        function init() {
            initMainScene();
            initPartPreviews();
            setupEventListeners();
            rebuildBug();
            animate();
        }

        function initMainScene() {
            const canvas = document.getElementById('main-canvas');
            const container = canvas.parentElement;

            mainScene = new THREE.Scene();
            mainScene.background = new THREE.Color(0x0d1117);

            mainCamera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 1, 1000);
            mainCamera.position.set(0, 20, 60);

            mainRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            mainRenderer.setSize(container.clientWidth, container.clientHeight);
            mainRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            mainRenderer.shadowMap.enabled = true;

            mainControls = new THREE.OrbitControls(mainCamera, mainRenderer.domElement);
            mainControls.enableDamping = true;
            mainControls.dampingFactor = 0.05;
            mainControls.target.set(0, 5, 0);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            mainScene.add(ambient);

            const directional = new THREE.DirectionalLight(0xffffff, 0.8);
            directional.position.set(50, 100, 50);
            directional.castShadow = true;
            mainScene.add(directional);

            const fillLight = new THREE.DirectionalLight(0x8888ff, 0.3);
            fillLight.position.set(-50, 50, -50);
            mainScene.add(fillLight);

            // Ground plane
            const groundGeo = new THREE.PlaneGeometry(200, 200);
            const groundMat = new THREE.MeshStandardMaterial({ color: 0x1a1a1a, roughness: 0.9 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            mainScene.add(ground);

            // Grid
            const grid = new THREE.GridHelper(100, 20, 0x30363d, 0x21262d);
            grid.position.y = 0.1;
            mainScene.add(grid);

            window.addEventListener('resize', () => {
                mainCamera.aspect = container.clientWidth / container.clientHeight;
                mainCamera.updateProjectionMatrix();
                mainRenderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function initPartPreviews() {
            const parts = ['Head', 'Thorax', 'Abdomen', 'Legs', 'Wings', 'Weapon', 'Antennae'];
            const container = document.getElementById('parts-preview');

            parts.forEach(partName => {
                const div = document.createElement('div');
                div.className = 'part-preview-item';
                div.id = `preview-${partName.toLowerCase()}`;

                const canvas = document.createElement('canvas');
                canvas.width = 150;
                canvas.height = 150;
                div.appendChild(canvas);

                const label = document.createElement('div');
                label.className = 'label';
                label.textContent = partName;
                div.appendChild(label);

                container.appendChild(div);

                // Create mini scene for this part
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x161b22);

                const camera = new THREE.PerspectiveCamera(50, 1, 1, 500);
                camera.position.set(0, 5, 20);
                camera.lookAt(0, 0, 0);

                const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                renderer.setSize(150, 150);

                const ambient = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambient);

                const light = new THREE.DirectionalLight(0xffffff, 0.6);
                light.position.set(10, 20, 10);
                scene.add(light);

                partPreviews[partName.toLowerCase()] = { scene, camera, renderer, mesh: null };
            });
        }

        function setupEventListeners() {
            // Part option clicks
            document.querySelectorAll('.part-options').forEach(container => {
                container.addEventListener('click', (e) => {
                    const option = e.target.closest('.part-option');
                    if (!option) return;

                    // Deselect siblings
                    container.querySelectorAll('.part-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');

                    // Update config
                    const category = container.id.replace('-options', '');
                    const value = option.dataset.value;

                    switch (category) {
                        case 'weapon': currentConfig.weapon = value; break;
                        case 'leg': currentConfig.legStyle = value; break;
                        case 'mobility': currentConfig.mobility = value; break;
                        case 'wing': currentConfig.wingType = value; break;
                        case 'defense': currentConfig.defense = value; break;
                        case 'texture': currentConfig.textureType = value; break;
                        case 'pattern': currentConfig.pattern = value; break;
                        case 'head': currentConfig.headType = value; break;
                        case 'thorax': currentConfig.thoraxType = value; break;
                        case 'abdomen': currentConfig.abdomenType = value; break;
                        case 'eye': currentConfig.eyeStyle = value; break;
                        case 'antenna': currentConfig.antennaStyle = value; break;
                    }

                    rebuildBug();
                });
            });

            // Sliders
            const sliders = ['hue', 'sat', 'light', 'bulk', 'speed', 'fury', 'instinct'];
            sliders.forEach(name => {
                const slider = document.getElementById(`${name}-slider`);
                if (slider) {
                    slider.addEventListener('input', (e) => {
                        const value = parseInt(e.target.value);
                        const display = document.getElementById(`${name}-value`);
                        if (display) display.textContent = value;

                        switch (name) {
                            case 'hue': currentConfig.hue = value; break;
                            case 'sat': currentConfig.saturation = value; break;
                            case 'light': currentConfig.lightness = value; break;
                            case 'bulk': currentConfig.bulk = value; break;
                            case 'speed': currentConfig.speed = value; break;
                            case 'fury': currentConfig.fury = value; break;
                            case 'instinct': currentConfig.instinct = value; break;
                        }

                        rebuildBug();
                    });
                }
            });

            // Color picker
            const colorPicker = document.getElementById('primary-color');
            colorPicker.addEventListener('input', (e) => {
                const hex = e.target.value;
                const hsl = hexToHSL(hex);
                currentConfig.hue = hsl.h;
                currentConfig.saturation = hsl.s;
                currentConfig.lightness = hsl.l;

                document.getElementById('hue-slider').value = hsl.h;
                document.getElementById('sat-slider').value = hsl.s;
                document.getElementById('light-slider').value = hsl.l;
                document.getElementById('hue-value').textContent = hsl.h;
                document.getElementById('sat-value').textContent = hsl.s;
                document.getElementById('light-value').textContent = hsl.l;

                rebuildBug();
            });
        }

        // ============================================
        // BUG BUILDING
        // ============================================

        function buildGenome() {
            // Create a genome object from current config
            const genome = {
                bulk: currentConfig.bulk,
                speed: currentConfig.speed,
                fury: currentConfig.fury,
                instinct: currentConfig.instinct,
                weapon: currentConfig.weapon,
                defense: currentConfig.defense,
                textureType: currentConfig.textureType,
                pattern: currentConfig.pattern,
                patternSeed: Math.floor(Math.random() * 10000),
                mobility: currentConfig.mobility,
                wingType: currentConfig.wingType,
                legStyle: currentConfig.legStyle,
                headType: currentConfig.headType,
                thoraxType: currentConfig.thoraxType,
                abdomenType: currentConfig.abdomenType,
                eyeStyle: currentConfig.eyeStyle,
                antennaStyle: currentConfig.antennaStyle,
                color: {
                    hue: currentConfig.hue,
                    saturation: currentConfig.saturation / 100,
                    lightness: currentConfig.lightness / 100,
                },
                getSizeMultiplier: function() {
                    const bulkFactor = this.bulk / 50;
                    const speedFactor = this.speed / 50;
                    return 0.8 + (bulkFactor * 0.3) - (speedFactor * 0.1);
                }
            };

            return genome;
        }

        function rebuildBug() {
            const genome = buildGenome();

            // Remove old bug
            if (currentBug) {
                mainScene.remove(currentBug);
            }

            try {
                // Create new bug
                const generator = new BugGenerator3D(genome);
                currentBug = generator.generate();
                currentBug.scale.setScalar(2);
                currentBug.position.y = 5;
                mainScene.add(currentBug);

                // Create animator
                animator = new BugAnimator(currentBug);

                // Apply wireframe if enabled
                if (wireframeMode) {
                    toggleWireframeOn(currentBug);
                }

                // Update part previews
                updatePartPreviews(genome);

            } catch (e) {
                console.error('Bug generation error:', e);
                console.error('Genome:', JSON.stringify(genome, null, 2));
            }

            // Update stats display
            updateStatsDisplay(genome);

            // Update genome display
            updateGenomeDisplay(genome);
        }

        function updatePartPreviews(genome) {
            const generator = new BugGenerator3D(genome);
            const scale = genome.getSizeMultiplier();
            const bulkFactor = 0.8 + (genome.bulk / 100) * 0.6;
            const speedFactor = 0.8 + (genome.speed / 100) * 0.4;

            // Head
            try {
                updatePartPreview('head', generator.createHead(speedFactor, scale));
            } catch (e) { console.error('Head preview error:', e); }

            // Thorax
            try {
                updatePartPreview('thorax', generator.createThorax(bulkFactor, speedFactor, scale));
            } catch (e) { console.error('Thorax preview error:', e); }

            // Abdomen
            try {
                updatePartPreview('abdomen', generator.createAbdomen(bulkFactor, scale));
            } catch (e) { console.error('Abdomen preview error:', e); }

            // Legs
            try {
                updatePartPreview('legs', generator.createLegs(genome.legStyle, scale));
            } catch (e) { console.error('Legs preview error:', e); }

            // Wings
            if (genome.mobility === 'winged') {
                try {
                    updatePartPreview('wings', generator.createWings(scale));
                } catch (e) { console.error('Wings preview error:', e); }
            } else {
                clearPartPreview('wings');
            }

            // Weapon
            try {
                updatePartPreview('weapon', generator.createWeapon(genome.weapon, scale));
            } catch (e) { console.error('Weapon preview error:', e); }

            // Antennae
            if (genome.antennaStyle !== 'none') {
                try {
                    updatePartPreview('antennae', generator.createAntennae(scale));
                } catch (e) { console.error('Antennae preview error:', e); }
            } else {
                clearPartPreview('antennae');
            }
        }

        function updatePartPreview(partName, mesh) {
            const preview = partPreviews[partName];
            if (!preview) return;

            // Remove old mesh
            if (preview.mesh) {
                preview.scene.remove(preview.mesh);
            }

            // Add new mesh
            mesh.scale.setScalar(1.5);
            preview.scene.add(mesh);
            preview.mesh = mesh;

            // Center the mesh
            const box = new THREE.Box3().setFromObject(mesh);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);

            mesh.position.sub(center);
            preview.camera.position.z = maxDim * 2.5;
            preview.camera.lookAt(0, 0, 0);

            // Render
            preview.renderer.render(preview.scene, preview.camera);
        }

        function clearPartPreview(partName) {
            const preview = partPreviews[partName];
            if (!preview) return;

            if (preview.mesh) {
                preview.scene.remove(preview.mesh);
                preview.mesh = null;
            }

            preview.renderer.render(preview.scene, preview.camera);
        }

        function updateStatsDisplay(genome) {
            const hp = 30 + Math.floor(genome.bulk * 1.2);
            const stamina = 50 + genome.bulk;
            const power = genome.bulk + genome.speed + genome.fury + genome.instinct +
                (genome.weapon === 'claws' ? 10 : genome.weapon === 'stinger' ? 8 : 0) +
                (genome.defense === 'shell' ? 10 : 0) +
                (genome.mobility === 'winged' ? 15 : genome.mobility === 'wallcrawler' ? 10 : 0);

            document.getElementById('hp-display').textContent = hp;
            document.getElementById('stamina-display').textContent = stamina;
            document.getElementById('power-display').textContent = power;
        }

        function updateGenomeDisplay(genome) {
            const display = {
                bulk: genome.bulk,
                speed: genome.speed,
                fury: genome.fury,
                instinct: genome.instinct,
                weapon: genome.weapon,
                defense: genome.defense,
                textureType: genome.textureType,
                pattern: genome.pattern,
                mobility: genome.mobility,
                legStyle: genome.legStyle,
                headType: genome.headType,
                thoraxType: genome.thoraxType,
                abdomenType: genome.abdomenType,
                eyeStyle: genome.eyeStyle,
                antennaStyle: genome.antennaStyle,
                color: genome.color,
            };

            document.getElementById('genome-display').textContent = JSON.stringify(display, null, 2);
        }

        // ============================================
        // CONTROLS
        // ============================================

        function resetCamera() {
            mainCamera.position.set(0, 20, 60);
            mainControls.target.set(0, 5, 0);
            mainControls.update();
        }

        function toggleRotation() {
            autoRotate = !autoRotate;
            mainControls.autoRotate = autoRotate;
        }

        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            if (currentBug) {
                if (wireframeMode) {
                    toggleWireframeOn(currentBug);
                } else {
                    rebuildBug();
                }
            }
        }

        function toggleWireframeOn(obj) {
            obj.traverse(child => {
                if (child.isMesh && child.material) {
                    child.material.wireframe = true;
                }
            });
        }

        function playAnimation() {
            animating = !animating;
            // Simulate walking speed when animating
            walkSpeed = animating ? 8 : 0;
        }

        function setAnimState(state) {
            animState = state;
            if (!animating) {
                animating = true;
            }
            // Reset animator state time for clean animation start
            if (animator) {
                animator.stateTime = 0;
                animator.state = '';  // Force state change
            }
        }

        function randomizeBug() {
            const weapons = ['mandibles', 'fangs', 'stinger', 'horn', 'pincers'];
            const legs = ['insect', 'spider', 'mantis', 'grasshopper', 'beetle', 'stick', 'centipede'];
            const mobility = ['ground', 'winged', 'wallcrawler'];
            const wingTypes = ['fly', 'beetle', 'dragonfly'];
            const defense = ['none', 'shell', 'agility', 'toxic'];
            const textureTypes = ['smooth', 'plated', 'rough'];
            const headTypes = ['round', 'triangular', 'square', 'elongated', 'shield'];
            const thoraxTypes = ['compact', 'elongated', 'wide', 'humped', 'segmented'];
            const abdomenTypes = ['round', 'oval', 'pointed', 'bulbous', 'segmented', 'sac', 'plated', 'tailed'];
            const eyes = ['compound', 'simple', 'stalked', 'multiple', 'sunken'];
            const antennae = ['segmented', 'clubbed', 'whip', 'horned', 'nubs', 'none'];
            const patterns = ['solid', 'striped', 'spotted'];

            currentConfig.weapon = weapons[Math.floor(Math.random() * weapons.length)];
            currentConfig.legStyle = legs[Math.floor(Math.random() * legs.length)];
            currentConfig.mobility = mobility[Math.floor(Math.random() * mobility.length)];
            currentConfig.wingType = wingTypes[Math.floor(Math.random() * wingTypes.length)];
            currentConfig.defense = defense[Math.floor(Math.random() * defense.length)];
            currentConfig.textureType = textureTypes[Math.floor(Math.random() * textureTypes.length)];
            currentConfig.pattern = patterns[Math.floor(Math.random() * patterns.length)];
            currentConfig.headType = headTypes[Math.floor(Math.random() * headTypes.length)];
            currentConfig.thoraxType = thoraxTypes[Math.floor(Math.random() * thoraxTypes.length)];
            currentConfig.abdomenType = abdomenTypes[Math.floor(Math.random() * abdomenTypes.length)];
            currentConfig.eyeStyle = eyes[Math.floor(Math.random() * eyes.length)];
            currentConfig.antennaStyle = antennae[Math.floor(Math.random() * antennae.length)];
            currentConfig.hue = Math.floor(Math.random() * 360);
            currentConfig.saturation = 30 + Math.floor(Math.random() * 50);
            currentConfig.lightness = 25 + Math.floor(Math.random() * 35);
            currentConfig.bulk = 20 + Math.floor(Math.random() * 80);
            currentConfig.speed = 20 + Math.floor(Math.random() * 80);
            currentConfig.fury = 20 + Math.floor(Math.random() * 80);
            currentConfig.instinct = 20 + Math.floor(Math.random() * 80);

            // Update UI
            updateUIFromConfig();
            rebuildBug();
        }

        function updateUIFromConfig() {
            // Update part options
            const optionMaps = {
                'weapon-options': currentConfig.weapon,
                'leg-options': currentConfig.legStyle,
                'mobility-options': currentConfig.mobility,
                'wing-options': currentConfig.wingType,
                'defense-options': currentConfig.defense,
                'texture-options': currentConfig.textureType,
                'pattern-options': currentConfig.pattern,
                'head-options': currentConfig.headType,
                'thorax-options': currentConfig.thoraxType,
                'abdomen-options': currentConfig.abdomenType,
                'eye-options': currentConfig.eyeStyle,
                'antenna-options': currentConfig.antennaStyle,
            };

            Object.entries(optionMaps).forEach(([containerId, value]) => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.querySelectorAll('.part-option').forEach(opt => {
                        opt.classList.toggle('selected', opt.dataset.value === value);
                    });
                }
            });

            // Update sliders
            document.getElementById('hue-slider').value = currentConfig.hue;
            document.getElementById('sat-slider').value = currentConfig.saturation;
            document.getElementById('light-slider').value = currentConfig.lightness;
            document.getElementById('bulk-slider').value = currentConfig.bulk;
            document.getElementById('speed-slider').value = currentConfig.speed;
            document.getElementById('fury-slider').value = currentConfig.fury;
            document.getElementById('instinct-slider').value = currentConfig.instinct;

            // Update displays
            document.getElementById('hue-value').textContent = currentConfig.hue;
            document.getElementById('sat-value').textContent = currentConfig.saturation;
            document.getElementById('light-value').textContent = currentConfig.lightness;
            document.getElementById('bulk-value').textContent = currentConfig.bulk;
            document.getElementById('speed-value').textContent = currentConfig.speed;
            document.getElementById('fury-value').textContent = currentConfig.fury;
            document.getElementById('instinct-value').textContent = currentConfig.instinct;

            // Update color picker
            document.getElementById('primary-color').value = hslToHex(currentConfig.hue, currentConfig.saturation, currentConfig.lightness);
        }

        function exportGenome() {
            const genome = buildGenome();
            const data = JSON.stringify(genome, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bug-genome.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyGenome() {
            const genome = buildGenome();
            const data = JSON.stringify(genome, null, 2);
            navigator.clipboard.writeText(data).then(() => {
                alert('Genome copied to clipboard!');
            });
        }

        // ============================================
        // UTILITIES
        // ============================================

        function hexToHSL(hex) {
            let r = parseInt(hex.slice(1, 3), 16) / 255;
            let g = parseInt(hex.slice(3, 5), 16) / 255;
            let b = parseInt(hex.slice(5, 7), 16) / 255;

            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0;
            } else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }

            return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
        }

        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            const a = s * Math.min(l, 1 - l);
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // ============================================
        // ANIMATION LOOP
        // ============================================

        function animate() {
            requestAnimationFrame(animate);

            // Update controls
            mainControls.update();

            // Animate bug if enabled
            if (animating && animator) {
                // Create fake fighter object with speed for walking animation
                const fakeFighter = {
                    vx: walkSpeed,
                    vy: 0,
                    vz: 0,
                    isFlying: currentConfig.mobility === 'winged',
                    isDiving: false,
                    grounded: currentConfig.mobility !== 'winged'
                };
                animator.update(0.016, animState, fakeFighter);
            }

            // Render main scene
            mainRenderer.render(mainScene, mainCamera);

            // Render part previews (less frequently)
            if (Math.random() < 0.1) {
                Object.values(partPreviews).forEach(preview => {
                    if (preview.mesh) {
                        preview.mesh.rotation.y += 0.02;
                        preview.renderer.render(preview.scene, preview.camera);
                    }
                });
            }
        }

        // Start
        init();
    </script>
</body>
</html>
